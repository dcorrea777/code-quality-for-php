name: Pull request
on:
    workflow_dispatch:
    pull_request_target:
        types:
            - labeled
            - synchronize
            - opened
            - edited

jobs:
    dependencies:
        uses: ./.github/workflows/dependencies.yml
    code-quality:
        needs: dependencies
        uses: ./.github/workflows/code-quality.yml
    provision:
        name: provision from PRs
        needs: code-quality
        runs-on: ubuntu-latest
        timeout-minutes: 1
        steps:
            -
                name: Check out repository code
                uses: actions/checkout@v2
            -
                name: get open pull_request
                id: set-result
                uses: actions/github-script@v6
                with:
                    script: |
                        const openPulls = await github.rest.pulls.list({
                            owner: context.repo.owner,
                            repo: context.repo.repo
                        })

                        const openPullsWithProvisioning = openPulls
                            .data
                            .filter(pr => pr.labels.filter(label => label.name === 'provisioning').length)
                            .map(pr => pr.head.ref)

                        return JSON.stringify({ prs: openPullsWithProvisioning })
            -
                name: open PRs
                run: echo "${{steps.set-result.outputs.result}}"
            -
                uses: actions/github-script@v6
                with:
                    script: |
                        github.rest.issues.createComment({
                            issue_number: context.issue.number,
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            body: 'ðŸ‘‹ Thanks for your PR! ðŸ”¥ The staging environment has already been provisioned ðŸ”¥ link is: http://autodoc.com.br'
                        })
